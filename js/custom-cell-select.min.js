angular.module("ui.grid").directive("uiGridCustomCellSelect",["$timeout","$document","$filter","rowSearcher","uiGridConstants","$parse","uiGridCellNavConstants","$window",function(v,e,t,l,o,E,f,a){var p="UP",w="DOWN",D="LEFT",S="RIGHT",h="##HIDDEN_INPUT_VALUE##";return{replace:!0,require:"^uiGrid",scope:!1,controller:function(){},compile:function(){return{pre:function(e,t,l,o){},post:function(e,t,l,n){var r=e,y=n.grid;function o(e){if(angular.element(e.target).hasClass("ui-grid-cell-contents"))if(0==e.button){var t=$(this).data().$scope;d(),r.ugCustomSelect.isDragging=!0,r.ugCustomSelect.lastMouseMoveEvt=e,function(e,t){r.ugCustomSelect.dragData.startCell.row=e,r.ugCustomSelect.dragData.startCell.col=t}(t.row,t.col),C()}else if(2==e.button){e.target.contentEditable=!0;var l=r.ugCustomSelect.hiddenInput[0];l.value=h,l.select(),setTimeout(function(){e.target.contentEditable=!1},500)}}function a(e){if(r.ugCustomSelect.isDragging){var t=$(this).data().$scope;t&&(function(e,t){r.ugCustomSelect.dragData.endCell.row=e,r.ugCustomSelect.dragData.endCell.col=t}(t.row,t.col),C())}}function i(e){if(r.ugCustomSelect.isDragging&&r.ugCustomSelect.lastMouseMoveEvt&&r.ugCustomSelect.lastMouseMoveEvt){var t=r.ugCustomSelect.lastMouseMoveEvt;if(r.ugCustomSelect.dragDirection.horizontal="",r.ugCustomSelect.dragDirection.vertical="",10<=Math.abs(t.pageX-e.pageX)&&(t.pageX<e.pageX?r.ugCustomSelect.dragDirection.horizontal=S:t.pageX>e.pageX&&(r.ugCustomSelect.dragDirection.horizontal=D)),10<=Math.abs(t.pageY-e.pageY)&&(t.pageY<e.pageY?r.ugCustomSelect.dragDirection.vertical=w:t.pageY>e.pageY&&(r.ugCustomSelect.dragDirection.vertical=p)),r.ugCustomSelect.dragDirection.horizontal||r.ugCustomSelect.dragDirection.vertical){var l=$(this).data().$scope;if(l){var o=function(e){var t={row:e.row,col:e.col};if(r.ugCustomSelect.dragDirection.horizontal){var l=y.renderContainers.body.cellNav.getFocusableCols(),o=l.indexOf(e.col);r.ugCustomSelect.dragDirection.horizontal==S?o<l.length-1&&(t.col=l[o+1]):0<o&&(t.col=l[o-1])}if(r.ugCustomSelect.dragDirection.horizontal){var a=y.renderContainers.body.cellNav.getFocusableRows(),n=a.indexOf(e.row);r.ugCustomSelect.dragDirection.horizontal==w?n<a.length-1&&(t.row=a[n+1]):0<n&&(t.row=a[n-1])}return t}(l);y.api.core.scrollToIfNecessary(o.row,o.col)}r.ugCustomSelect.lastMouseMoveEvt=e}}}function u(e){r.ugCustomSelect.isDragging&&(r.ugCustomSelect.isDragging=!1,r.ugCustomSelect.lastMouseMoveEvt=null,r.ugCustomSelect.dragDirection={},C())}function c(e){67===e.keyCode&&(e.ctrlKey||e.metaKey)&&window.getSelection()+""==""&&(document.execCommand("copy"),e.preventDefault())}function s(e){var t,l;l=e.originalEvent.clipboardData?(t=e.originalEvent.clipboardData,"text/plain"):(t=window.clipboardData,"Text"),t&&0<angular.element(document.activeElement).parents(".ui-grid").length&&(window.getSelection()+""==""||window.getSelection()+""==" "||window.getSelection()==h)&&0<y.cellNav.focusedCells.length&&(t.setData(l,function(){for(var e=y.cellNav.focusedCells,t="",l=0;l<e.length;l++){var o=e[l],a=y.getCellValue(o.row,o.col);t+=a||"";var n=l<e.length-1?e[l+1].row.uid:"";n&&n==o.row.uid?l!==e.length-1&&(t+="\t"):t+="\n"}return t}()),e.preventDefault())}function g(e){var t=e.originalEvent.clipboardData||window.clipboardData;if(t){var l=t.getData("Text"),o=y.cellNav.focusedCells[0];if(o)for(var a=o.row.uid,n=o.col.uid,r=y.getVisibleRows(),i=y.columns,u=0;u<r.length;u++){if(r[u].uid===a){for(var c=0;c<i.length;c++){if((v=i[c]).uid===n)for(var s=l.split("\n"),g=0;g<s.length-1;g++){var d=s[g];if(u+g<r.length)for(var C=d.split("\t"),m=0;m<C.length;m++){var v,f=C[m];if(c+m<i.length)if((v=i[c+m]).colDef.enableCellEdit){var p=i[c+m].field,w=E(p),D=w.assign,S=r[u+g].entity,h=w(S),b=f;"number"==v.colDef.type&&(b=parseFloat(b)||0),D(S,b),y.api.edit.raise.afterCellEdit(S,v.colDef,b,h),y.api.core.refresh()}}}}break}}}else console.log("Clipboard API not supported in browser")}function d(){r.ugCustomSelect.dragData.endCell.row=null,r.ugCustomSelect.dragData.endCell.col=null,r.ugCustomSelect.dragData.startCell.row=null,r.ugCustomSelect.dragData.startCell.col=null,m()}function C(){m();var e=function(){var e=y.renderContainers.body.renderedRows.indexOf(r.ugCustomSelect.dragData.startCell.row),t=y.renderContainers.body.renderedRows.indexOf(r.ugCustomSelect.dragData.endCell.row),l=y.renderContainers.body.renderedColumns.indexOf(r.ugCustomSelect.dragData.startCell.col),o=y.renderContainers.body.renderedColumns.indexOf(r.ugCustomSelect.dragData.endCell.col);-1===t&&(t=e);-1===o&&(o=l);return{row:{start:e<t?e:t,end:e<t?t:e},col:{start:l<o?l:o,end:l<o?o:l}}}(r.ugCustomSelect.dragData.startCell,r.ugCustomSelect.dragData.endCell);r.ugCustomSelect.selectedCells=function(e){for(var t=y.renderContainers.body.renderedColumns,l=y.renderContainers.body.renderedRows,o=[],a=e.row.start;a<=e.row.end;a++)for(var n=l[a],r=e.col.start;r<=e.col.end;r++){var i=t[r],u=(s=a,(c=i)&&c.uid&&"number"==typeof s?angular.element("#"+y.id+"-"+s+"-"+c.uid+"-cell"):null);u&&o.push({row:n,col:i,elem:u})}var c,s;return o}(e);for(var t=[],l=0;l<r.ugCustomSelect.selectedCells.length;l++){var o=r.ugCustomSelect.selectedCells[l];t.push(n.cellNav.makeRowCol(o))}if(y.cellNav.focusedCells=t,r.$broadcast(f.CELL_NAV_EVENT),0<t.length){var a=t[t.length-1];y.api.cellNav.raise.navigate(a,y.cellNav.lastRowCol),y.cellNav.lastRowCol=a}}function m(){r.ugCustomSelect.selectedCells=[]}r.ugCustomSelect={hiddenInput:angular.element('<input style="height: 0px; width: 0px; position: absolute; top: 0; z-index: -1;" type="text" value="'+h+'" />').appendTo(t),isDragging:!1,lastMouseMoveEvt:null,dragDirection:{},selectedCells:[],dragData:{startCell:{row:null,col:null},endCell:{row:null,col:null}}},v(function(){y.element.on("mousedown",".ui-grid-cell-contents",o),y.element.on("mouseenter",".ui-grid-cell-contents",a),y.element.on("mousemove",".ui-grid-cell-contents",i),angular.element("body").on("mouseup",u),angular.element(document).on("keydown",c),angular.element(document).on("copy",s),y.api.core.on.filterChanged(r,d),y.api.core.on.columnVisibilityChanged(r,d),y.api.core.on.rowsVisibleChanged(r,d),y.api.core.on.sortChanged(r,d),angular.element(document).on("paste",g)})}}}}}]);
